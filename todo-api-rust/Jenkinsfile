pipeline {
    agent any
    
    environment {
        RUST_VERSION = '1.75.0'
        APP_NAME = 'todo-api-rust'
        DEPLOY_PATH = '/opt/todo-api-rust'
        SERVICE_NAME = 'todo-api-rust'
        API_PORT = '8081'
    }
    
    stages {
        stage('ðŸ” Checkout') {
            steps {
                checkout scm
                echo "âœ… CÃ³digo baixado do repositÃ³rio"
            }
        }
        
        stage('ðŸ¦€ Setup Rust') {
            steps {
                sh '''#!/bin/bash
                    # Carregar ambiente Rust
                    export PATH="$HOME/.cargo/bin:$PATH"
                    if [ -f "$HOME/.cargo/env" ]; then
                        source $HOME/.cargo/env
                    fi
                    
                    # Verificar se Rust estÃ¡ instalado
                    which rustc || {
                        echo "âŒ Rust nÃ£o instalado! Execute no servidor:"
                        echo "sudo -u jenkins bash -c 'curl --proto =https --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y'"
                        exit 1
                    }
                    
                    # Verificar versÃ£o
                    rustc --version
                    cargo --version
                '''
            }
        }
        
        stage('ðŸ“¦ Dependencies') {
            steps {
                sh '''#!/bin/bash
                    export PATH="$HOME/.cargo/bin:$PATH"
                    cd todo-api-rust
                    cargo fetch
                '''
                echo "âœ… DependÃªncias baixadas"
            }
        }
        
        stage('ðŸ”¨ Build') {
            steps {
                sh '''#!/bin/bash
                    export PATH="$HOME/.cargo/bin:$PATH"
                    cd todo-api-rust
                    cargo build --release
                '''
                echo "âœ… Build concluÃ­do"
            }
        }
        
        stage('ðŸ§ª Test') {
            steps {
                sh '''#!/bin/bash
                    export PATH="$HOME/.cargo/bin:$PATH"
                    cd todo-api-rust
                    cargo test --release || true
                '''
                echo "âœ… Testes executados"
            }
        }
        
        stage('ðŸ“¤ Deploy') {
            steps {
                sh '''
                    # Copiar binÃ¡rio
                    cp todo-api-rust/target/release/todo-api ${DEPLOY_PATH}/
                    
                    # Copiar .env se nÃ£o existir
                    if [ ! -f ${DEPLOY_PATH}/.env ]; then
                        cp todo-api-rust/.env.production ${DEPLOY_PATH}/.env
                        echo "âš ï¸ Arquivo .env criado - configure as variÃ¡veis!"
                    fi
                    
                    # Ajustar permissÃµes
                    chmod +x ${DEPLOY_PATH}/todo-api
                '''
                echo "âœ… Arquivos copiados"
            }
        }
        
        stage('ðŸ”„ Restart Service') {
            steps {
                sh '''
                    # Criar/atualizar serviÃ§o systemd
                    sudo tee /etc/systemd/system/${SERVICE_NAME}.service > /dev/null <<EOF
[Unit]
Description=Todo API Rust
After=network.target mysql.service

[Service]
Type=simple
User=jenkins
Group=jenkins
WorkingDirectory=${DEPLOY_PATH}
ExecStart=${DEPLOY_PATH}/todo-api
Restart=always
RestartSec=5
EnvironmentFile=${DEPLOY_PATH}/.env

[Install]
WantedBy=multi-user.target
EOF

                    # Recarregar e reiniciar
                    sudo systemctl daemon-reload
                    sudo systemctl enable ${SERVICE_NAME}
                    sudo systemctl restart ${SERVICE_NAME}
                    
                    # Aguardar inicializaÃ§Ã£o
                    sleep 3
                    
                    # Verificar status
                    sudo systemctl status ${SERVICE_NAME} --no-pager || true
                '''
                echo "âœ… ServiÃ§o reiniciado"
            }
        }
        
        stage('âœ… Health Check') {
            steps {
                sh '''
                    sleep 2
                    # Testar se a API estÃ¡ respondendo
                    curl -s http://localhost:${API_PORT}/ | head -100 || echo "âš ï¸ API pode estar iniciando..."
                '''
                echo "âœ… Health check concluÃ­do"
            }
        }
    }
    
    post {
        success {
            echo "ðŸŽ‰ Deploy concluÃ­do com sucesso!"
            echo "ðŸ“¡ API disponÃ­vel em: https://191-235-32-212.nip.io/rust-api"
        }
        failure {
            echo "âŒ Deploy falhou! Verifique os logs."
        }
        always {
            cleanWs()
        }
    }
}
