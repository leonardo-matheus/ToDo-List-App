pipeline {
    agent any
    
    environment {
        RUST_VERSION = '1.75.0'
        APP_NAME = 'todo-api-rust'
        DEPLOY_PATH = '/opt/todo-api-rust'
        SERVICE_NAME = 'todo-api-rust'
        API_PORT = '8081'
    }
    
    stages {
        stage('ðŸ” Checkout') {
            steps {
                checkout scm
                echo "âœ… CÃ³digo baixado do repositÃ³rio"
            }
        }
        
        stage('ðŸ”§ Install System Dependencies') {
            steps {
                sh '''
                    echo "ðŸ“¦ Instalando dependÃªncias do sistema..."
                    sudo apt-get update
                    sudo apt-get install -y pkg-config libssl-dev build-essential
                '''
                echo "âœ… DependÃªncias do sistema instaladas"
            }
        }
        
        stage('ðŸ¦€ Setup Rust') {
            steps {
                sh '''
                    # Verificar se Rust estÃ¡ instalado
                    if ! command -v rustc &> /dev/null; then
                        echo "ðŸ“¦ Instalando Rust..."
                        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
                    fi
                    
                    # Carregar ambiente Rust
                    . $HOME/.cargo/env
                    
                    # Verificar versÃ£o
                    rustc --version
                    cargo --version
                '''
            }
        }
        
        stage('ðŸ“¦ Dependencies') {
            steps {
                sh '''
                    . $HOME/.cargo/env
                    cd todo-api-rust
                    cargo fetch
                '''
                echo "âœ… DependÃªncias baixadas"
            }
        }
        
        stage('ðŸ”¨ Build') {
            steps {
                sh '''
                    . $HOME/.cargo/env
                    cd todo-api-rust
                    cargo build --release
                '''
                echo "âœ… Build concluÃ­do"
            }
        }
        
        stage('ðŸ§ª Test') {
            steps {
                sh '''
                    . $HOME/.cargo/env
                    cd todo-api-rust
                    cargo test --release || true
                '''
                echo "âœ… Testes executados"
            }
        }
        
        stage('ðŸ“¤ Deploy') {
            steps {
                sh '''
                    # Criar diretÃ³rio de deploy
                    sudo mkdir -p ${DEPLOY_PATH}
                    
                    # Copiar binÃ¡rio
                    sudo cp todo-api-rust/target/release/todo-api ${DEPLOY_PATH}/
                    
                    # Copiar .env se nÃ£o existir
                    if [ ! -f ${DEPLOY_PATH}/.env ]; then
                        sudo cp todo-api-rust/.env.production ${DEPLOY_PATH}/.env
                        echo "âš ï¸ Arquivo .env criado - configure as variÃ¡veis!"
                    fi
                    
                    # Ajustar permissÃµes
                    sudo chown -R www-data:www-data ${DEPLOY_PATH}
                    sudo chmod +x ${DEPLOY_PATH}/todo-api
                '''
                echo "âœ… Arquivos copiados"
            }
        }
        
        stage('ðŸ”„ Restart Service') {
            steps {
                sh '''
                    # Criar/atualizar serviÃ§o systemd
                    sudo tee /etc/systemd/system/${SERVICE_NAME}.service > /dev/null <<EOF
[Unit]
Description=Todo API Rust
After=network.target mysql.service

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=${DEPLOY_PATH}
ExecStart=${DEPLOY_PATH}/todo-api
Restart=always
RestartSec=5
Environment=RUST_LOG=info
Environment=PORT=${API_PORT}

[Install]
WantedBy=multi-user.target
EOF

                    # Recarregar e reiniciar
                    sudo systemctl daemon-reload
                    sudo systemctl enable ${SERVICE_NAME}
                    sudo systemctl restart ${SERVICE_NAME}
                    
                    # Aguardar inicializaÃ§Ã£o
                    sleep 3
                    
                    # Verificar status
                    sudo systemctl status ${SERVICE_NAME} --no-pager || true
                '''
                echo "âœ… ServiÃ§o reiniciado"
            }
        }
        
        stage('âœ… Health Check') {
            steps {
                sh '''
                    sleep 2
                    # Testar se a API estÃ¡ respondendo
                    curl -s http://localhost:${API_PORT}/ | head -100 || echo "âš ï¸ API pode estar iniciando..."
                '''
                echo "âœ… Health check concluÃ­do"
            }
        }
    }
    
    post {
        success {
            echo "ðŸŽ‰ Deploy concluÃ­do com sucesso!"
            echo "ðŸ“¡ API disponÃ­vel em: https://191-235-32-212.nip.io/rust-api"
        }
        failure {
            echo "âŒ Deploy falhou! Verifique os logs."
        }
        always {
            cleanWs()
        }
    }
}
